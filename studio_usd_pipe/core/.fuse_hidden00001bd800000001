import os
import shutil

from maya import OpenMaya


def get_nodes(node_type):
    mit_dependency_nodes = OpenMaya.MItDependencyNodes()
    mobjects = OpenMaya.MObjectArray()
    while not mit_dependency_nodes.isDone():
        mobject = mit_dependency_nodes.item()
        if mobject.hasFn(node_type):
            mobjects.append(mobject)
        mit_dependency_nodes.next()
    return mobjects


def get_string_attribute_values(mobjects, attribute):
    data = {}
    for index in range(mobjects.length()):
        mfn_Dependency_node = OpenMaya.MFnDependencyNode(mobjects[index])
        mplug = mfn_Dependency_node.findPlug(attribute)
        data.setdefault(mplug, mplug.asString())
    return data


def export_source_images(dirname, assign=True):
    mobjects = get_nodes(OpenMaya.MFn.kFileTexture)
    bundles = get_string_attribute_values(mobjects, 'fileTextureName')
    for mplug, source_file in bundles.items():
        target_file = os.path.join(dirname, os.path.split(source_file)[-1])
        shutil.copy2(source_file, target_file)
        if assign:
            mplug.setString(target_file)


